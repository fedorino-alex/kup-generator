name: Docker Image CI

on:
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., 1.3.0)'
        required: true
        type: string

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Extract tag name
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          # For release events, use the tag name from the release
          TAG="${{ github.event.release.tag_name }}"
          echo "🎉 Triggered by release: $TAG"
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # For manual triggers, use the input tag
          TAG="${{ inputs.tag }}"
          echo "🔧 Triggered manually for tag: $TAG"
        else
          echo "❌ Unexpected event type: ${{ github.event_name }}"
          exit 1
        fi
        
        echo "🏷️ Processing tag: $TAG"
        
        # Remove 'v' prefix if it exists
        VERSION=${TAG#v}
        echo "📦 Docker version: $VERSION"
        
        echo "tag=${VERSION}" >> $GITHUB_OUTPUT
        echo "full_tag=${TAG}" >> $GITHUB_OUTPUT
      id: extract_tag
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag fedorinoalex/kup-generator:${{ steps.extract_tag.outputs.tag }}
    - name: Push the Docker image
      run: docker push fedorinoalex/kup-generator:${{ steps.extract_tag.outputs.tag }}
    - name: Tag image as latest
      run: docker tag fedorinoalex/kup-generator:${{ steps.extract_tag.outputs.tag }} fedorinoalex/kup-generator:latest
    - name: Push latest tag
      run: docker push fedorinoalex/kup-generator:latest
